<?phpinclude('incs/db.inc.php');require_once('classes/config.class.php');mysql_query("SET NAMES utf8");$file = fopen("table.sql","w");fputs($file,"ALTER TABLE comments ADD COLUMN fid INTEGER DEFAULT '0' AFTER uid;\n");fputs($file,"ALTER TABLE users ADD COLUMN show_hid BOOL DEFAULT 0;\n");fputs($file,"ALTER TABLE users ADD COLUMN sort_to BOOL DEFAULT 0;\n");fputs($file,"ALTER TABLE users ADD COLUMN threads_on_page INTEGER DEFAULT 30;\n");fputs($file,"CREATE TABLE tmp(old_cid INTEGER, new_cid INTEGER);\n");fputs($file,"CREATE TABLE articles(id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY, fid INTEGER, title VARCHAR(512), body MEDIUMTEXT, timestamp INTEGER, uid INTEGER, active BOOL, approoved INTEGER);\n");fputs($file,"CREATE TABLE threads(tid INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY, fid INTEGER NOT NULL, uid INTEGER NOT NULL, posting_date INTEGER NOT NULL, chandging_date INTEGER, attached BOOL, closed BOOL, deleted BOOL, deleted_by INTEGER, deleted_for VARCHAR(256) );\n");$tid_q = mysql_query("SELECT * FROM comments WHERE tid = ( SELECT MAX( tid ) FROM comments );");if($tid_q){	$tid_r = mysql_fetch_array($tid_q);	$cid_c = $tid_r['cid'];	$tid_c = $tid_r['tid'];}else{	echo "<p><b>Error: ".mysql_error()."</b></p>";	exit();}$ath = mysql_query("SELECT * FROM forum_messages;");if($ath){	while($it = mysql_fetch_array($ath))	{		$cid =$it['message_id'];		$tid = $it['thread_id'];		$fid =$it['forum_id'];		$username = $it['user_name'];		$usq = mysql_query("SELECT id FROM users WHERE nick = '$username';");		if($usq)		{			$usr = mysql_fetch_array($usq);			$uid = $usr['id'];		}		else		{			echo "<p><b>Error: ".mysql_error()."</b></p>";			exit();		}		$referer =$it['response_to'];		if($it['stat']=='opened') 		{			$deleted = 0; 		}		else		{			$deleted = 1;		}		$deleted_for =$it['delete_reason'];		$deleted_by =$it['delete_moder'];		$timestamp =$it['posting_date'];		$subject =$it['title'];		$comment =$it['message_text'];		$comment = str_replace("'","\'",$comment);		$useragent =$it['useragent'];		$IP =$it['ip_adress'];		fputs($file,"INSERT INTO comments(tid, uid, fid, referer, parent, deleted, deleted_for, deleted_by, timestamp, subject, comment, ip, useragent) VALUES('".$tid."', '".$uid."', '".$fid."', '".$referer."', '".$parent."', '".$deleted."', '".$deleted_for."', '".$deleted_by."', '".$timestamp."', '".$subject."', '".$comment."', '".$ip."', '".$useragent."');\n");		fputs($file,"INSERT INTO tmp(old_cid, new_cid) VALUES('".$cid."',(SELECT cid FROM comments WHERE timestamp = '".$timestamp."' AND ip = '".$ip."' AND useragent = '".$useragent."'));\n");		if($referer!=0)		{			fputs($file,"UPDATE comments SET referer = (SELECT new_cid FROM tmp WHERE old_cid = '".$cid."') WHERE referer = '".$cid."' AND tid !=0;\n");		}	}}else{	echo "<p><b>Error: ".mysql_error()."</b></p>";	exit();}$thr = mysql_query("SELECT * FROM forum_threads;");if($thr){	while($th = mysql_fetch_array($thr))	{		$tid = $th['thread_id'] + $tid_c;		$fid = $th['forum_id'];		$posting_date = $th['posting_date'];		$deleted_for = $th['delete_reason'];		$deleted_by = base::eread('users', 'id', '', 'nick', $th['delete_moder']);		if($th['chandging_date']>0)		{			$chandging_date = $th['chandging_date'];		}		else		{			$chandging_date = $posting_date;		}		if($th['stat']=="attached")		{			$attached = 1;			$closed = 0;			$deleted = 0;		}		else if($th['stat']=="closed")		{			$attached = 0;			$closed = 1;			$deleted = 0;		}		else if($th['stat']=="deleted")		{			$attached = 0;			$closed = 0;			$deleted = 1;		}		else 		{			$attached = 0;			$closed = 0;		}				fputs($file,"INSERT INTO threads (tid, fid, posting_date, chandging_date, attached, closed, deleted) VALUES ('$tid', '$fid', '$posting_date', '$chandging_date', '$attached', '$closed', '$deleted');\n");	}}else{	echo "<p><b>Error: ".mysql_error()."</b></p>";	exit();}fputs($file,"UPDATE comments SET tid = tid + $tid_c WHERE cid > $cid_c;\n");fputs($file,"DROP TABLE tmp;\n");fclose($file);echo Done;?>